#!/usr/bin/env ruby

require 'rubygems'
require 'canine-2'

Canine.app do
	def redirect(to)
		to.keys.map { |from|
			"#{to[from]}\t#{from}"
		}.join("\n")
	end

	cmd 'list' => "Display the currently-blocked domains" do
		list = File.readlines('/etc/hosts').select { |line|
			line.include? '127.0.0.1'
		}.select { |line| not line.include? 'localhost' }
		puts (list.empty?) ? "No hosts blocked" : list.map { |line|
			line.gsub(/^.*\t/,'')
		}.join
	end

	cmd 'allow' => "Remove a domain from a blocklist" do |*hosts|
		lines = IO.readlines("/etc/hosts")
		hosts.each { |host|
			lines.delete_if { |line|
				line =~ /^\d{1,3}(\.\d{1,3}){3}\t#{host}/
			}
		}
		system(
			"sudo su <<EOF\ncat <<END > /etc/hosts\n#{lines.join}END\nEOF"
		)
		puts "Removed #{hosts.join(', ')} from the blocklist"
	end

	option( 'to-ip' => 't', :default => '127.0.0.1', :desc =>
		"Redeirect to a specified IP address" )
	cmd 'block' => "Block a domain using /etc/hosts" do |*hosts|
		system(
			"sudo su <<EOF\necho '#{
				hosts.map { |host|
					redirect host => @options['to-ip']
				}
			}' >> /etc/hosts\nEOF"
		)
	end
end
